import streamlit as st
import base64
from openai import OpenAI
from urllib.parse import quote_plus
from datetime import datetime, timedelta
import streamlit.components.v1 as components

# --- üåê 0. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ---
CITY_DATA = {
    "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": ["‡πÇ‡∏ï‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß", "‡πÇ‡∏≠‡∏ã‡∏≤‡∏Å‡πâ‡∏≤", "‡∏Æ‡∏≠‡∏Å‡πÑ‡∏Å‡πÇ‡∏î", "‡∏ü‡∏∏‡∏Å‡∏∏‡πÇ‡∏≠‡∏Å‡∏∞"],
    "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ": ["‡πÇ‡∏ã‡∏•", "‡∏õ‡∏π‡∏ã‡∏≤‡∏ô", "‡∏≠‡∏¥‡∏ô‡∏ä‡∏≠‡∏ô", "‡πÄ‡∏ä‡∏à‡∏π"],
    "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": ["‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢", "‡πÇ‡∏Æ‡∏à‡∏¥‡∏°‡∏¥‡∏ô‡∏´‡πå", "‡∏î‡∏≤‡∏ô‡∏±‡∏á"],
    "‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô": ["‡πÑ‡∏ó‡πÄ‡∏õ", "‡πÄ‡∏Å‡∏≤‡∏™‡∏á", "‡πÑ‡∏ñ‡∏à‡∏á"],
    "‡∏à‡∏µ‡∏ô": ["‡∏õ‡∏±‡∏Å‡∏Å‡∏¥‡πà‡∏á", "‡πÄ‡∏ã‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏Æ‡πâ", "‡∏Å‡∏ß‡∏≤‡∏á‡πÇ‡∏à‡∏ß"]
}

LANG_DICT = {
    "Thai": {
        "settings": "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤",
        "lang_label": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤",
        "free_mode": "‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ",
        "theme_label": "‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏õ (‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á)",
        "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        "travel_info": "üóìÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "dest": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢",
        "city": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
        "start": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°",
        "end": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î",
        "activity": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
        "act_list": ["‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏Å‡∏µ", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á"],
        "gender": "‡πÄ‡∏û‡∏®",
        "male": "‡∏ä‡∏≤‡∏¢",
        "female": "‡∏´‡∏ç‡∏¥‡∏á",
        "upload": "üì∏ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ä‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á",
        "camera": "ü§≥ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á",
        "run": "‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á 3D",
        "temp": "üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢",
        "warn": "‚ö†Ô∏è **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: ‡∏´‡∏ô‡∏≤‡∏ß‡∏à‡∏±‡∏î**",
        "analysis_title": "üîç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ 3D",
    }
}

# --- ‚öôÔ∏è 1. Logic & AI ---
def process_logic(api_key, country, city, activity, gender, use_free_mode, img_file, lang):
    # ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô AI
    v_out = f"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {city}, {country} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
    return v_out

# --- üé® 2. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ---
def main_dashboard():
    lang = st.session_state.get('lang_choice', 'Thai')
    t = LANG_DICT["Thai"] # ‡∏¢‡∏∂‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ

    with st.sidebar:
        st.title(t["settings"])
        api_key = st.text_input("OpenAI API Key", type="password")
        use_free_mode = st.toggle(t["free_mode"], value=not api_key)
        theme_mode = st.toggle(t["theme_label"], value=False)
        
        # ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
        if theme_mode:
            st.markdown("""
                <style>
                .stApp { background-color: #0F172A; color: #F8FAFC; }
                [data-testid="stSidebar"] { background-color: #1E293B; }
                .stMarkdown, p, h1, h2, h3, label, .stMetric { color: #F1F5F9 !important; }
                .stSelectbox div, .stTextInput div { background-color: #334155 !important; color: white !important; }
                .analysis-box { background: #1E293B; padding: 20px; border-radius: 12px; border: 1px solid #475569; }
                </style>
            """, unsafe_allow_html=True)

        if st.button(t["logout"], use_container_width=True):
            st.session_state['logged_in'] = False
            st.rerun()

    st.title("üåç Tripnify Dashboard")
    col1, col2 = st.columns([1, 1.4])

    with col1:
        with st.container(border=True):
            st.subheader(t["travel_info"])
            country = st.selectbox(t["dest"], list(CITY_DATA.keys()))
            city = st.selectbox(t["city"], CITY_DATA[country]) # ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
            
            d_col1, d_col2 = st.columns(2)
            start_date = d_col1.date_input(t["start"], datetime.now())
            end_date = d_col2.date_input(t["end"], datetime.now() + timedelta(days=5))
            
            activity = st.selectbox(t["activity"], t["act_list"])
            gender = st.radio(t["gender"], [t["male"], t["female"]], horizontal=True)
            
            # ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á
            tab1, tab2 = st.tabs([t["upload"], t["camera"]])
            with tab1: img_file = st.file_uploader("", type=['jpg', 'png'], key="file_up")
            with tab2: cam_file = st.camera_input("")
            
            active_img = img_file if img_file else cam_file
            run_btn = st.button(t["run"], use_container_width=True, type="primary")

    with col2:
        if run_btn:
            v_out = process_logic(api_key, country, city, activity, gender, use_free_mode, active_img, "Thai")
            
            st.metric(label=t["temp"], value="1.8¬∞C")
            st.warning(t["warn"])
            
            st.markdown(f"### {t['analysis_title']}")
            
            # ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏• 3D ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏î‡πâ 360 ‡∏≠‡∏á‡∏®‡∏≤ (‡πÉ‡∏ä‡πâ Placeholder ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î AI)
            st.info("üì¶ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÇ‡∏°‡πÄ‡∏î‡∏• 3D ‡πÅ‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏î‡πâ 360 ‡∏≠‡∏á‡∏®‡∏≤...")
            
            # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏±‡∏á 3D Viewer (HTML/JS)
            components.html("""
                <div style="width:100%; height:300px; background:#334155; border-radius:10px; display:flex; align-items:center; justify-content:center; color:white; border: 2px dashed #6366F1;">
                    <div style="text-align:center;">
                        <p>3D Character Preview</p>
                        <small>(‡πÇ‡∏´‡∏°‡∏î OpenAI: ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏´‡∏°‡∏∏‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß)</small>
                    </div>
                </div>
            """, height=320)
            
            st.markdown(f'<div class="analysis-box">{v_out}</div>', unsafe_allow_html=True)
        else:
            st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ä‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö")

# --- üîë 3. ‡∏´‡∏ô‡πâ‡∏≤ Login ---
def login_page():
    st.markdown("""<style>
        .login-header { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; margin-bottom: 2rem; }
        .social-btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 8px; background: white; margin-bottom: 10px; cursor: pointer; color: #3c4043; font-weight: 500; }
    </style>""", unsafe_allow_html=True)

    st.markdown("""
        <div class="login-header">
            <img src="https://cdn-icons-png.flaticon.com/512/201/201623.png" width="120">
            <h1>Tripnify</h1>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
        </div>
    """, unsafe_allow_html=True)

    # ‡∏õ‡∏∏‡πà‡∏° Login Google & Facebook ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
    c1, c2, c3 = st.columns([1, 2, 1])
    with c2:
        if st.button("üîµ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Facebook", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()
        if st.button("üî¥ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()

    st.markdown("<p style='text-align: center; color: gray;'>‡∏´‡∏£‡∏∑‡∏≠</p>", unsafe_allow_html=True)
    
    with c2:
        user = st.text_input("Username")
        pwd = st.text_input("Password", type="password")
        if st.button("üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True, type="primary"):
            st.session_state['logged_in'] = True; st.rerun()

# --- üöÄ 4. ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å ---
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False

if st.session_state['logged_in']:
    main_dashboard()
else:
    login_page()
