import streamlit as st
import base64
from openai import OpenAI
from urllib.parse import quote_plus
from datetime import datetime, timedelta

# --- ‚öôÔ∏è 1. Logic ‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ---
def process_logic(api_key, country, activity, gender, use_free_mode, uploaded_file, lang):
    # Prompt ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û (‡∏Ç‡πâ‡∏≠ 8) - ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
    if lang == "Thai":
        p_critique = "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏® 1.8¬∞C ‡πÉ‡∏ô‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: 1.‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≠‡∏Å 2.‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á 3.‡∏´‡∏°‡∏ß‡∏Å 4.‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤ 5.‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°"
    else:
        p_critique = "Critique this outfit for 1.8¬∞C weather based on: 1.Outerwear 2.Pants 3.Headwear 4.Footwear 5.Accessories."

    if api_key and not use_free_mode:
        try:
            client = OpenAI(api_key=api_key)
            v_out = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" if lang == "Thai" else "No image"
            
            if uploaded_file:
                b64_img = base64.b64encode(uploaded_file.getvalue()).decode("utf-8")
                v_resp = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[{"role": "user", "content": [
                        {"type": "text", "text": p_critique},
                        {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{b64_img}"}}
                    ]}]
                )
                v_out = v_resp.choices[0].message.content
            
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á 3D (‡∏Ç‡πâ‡∏≠ 9)
            img_prompt = f"3D Pixar style character {gender} in {country} winter clothes, 1.8C professional gear, high quality."
            img_resp = client.images.generate(model="dall-e-3", prompt=img_prompt, n=1)
            return v_out, img_resp.data[0].url

        except Exception as e:
            return f"Error: {str(e)}", None
    else:
        # ‡πÇ‡∏´‡∏°‡∏î‡∏ü‡∏£‡∏µ: ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
        v_free = """‡πÉ‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ 1.8¬∞C ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ô‡∏±‡∏Å ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ:
        1. ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô: ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≤‡∏£‡πå‡∏î‡∏¥‡πÅ‡∏Å‡∏ô
        2. ‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á: ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ú‡πâ‡∏≤‡∏´‡∏ô‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Å‡∏Å‡∏¥‡πâ‡∏á‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô
        3. ‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤: ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏π‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏¢‡πá‡∏ô
        4. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏Ñ‡∏≠"""
        sample_img = "https://images.unsplash.com/photo-1520975954732-4cdd221ee434?q=80&w=1000"
        return v_free, sample_img

# --- üé® 2. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ---
def main_dashboard():
    # CSS ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    st.markdown("""<style>
        .critique-box { background: #fffbeb; padding: 20px; border-radius: 12px; border: 1px solid #fef3c7; color: #92400e; margin-bottom: 20px; }
        .must-buy-card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #ff4b4b; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .shop-link { color: #4f46e5; text-decoration: none; font-weight: bold; }
    </style>""", unsafe_allow_html=True)

    with st.sidebar:
        lang = st.radio("Language", ["Thai", "English"], key='lang_choice')
        st.divider()
        api_key = st.text_input("OpenAI API Key", type="password")
        use_free_mode = st.toggle("‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ" if lang == "Thai" else "Free Mode", value=not api_key)
        if st.button("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"): 
            st.session_state['logged_in'] = False
            st.rerun()

    st.title("üåç Tripnify Dashboard")
    col1, col2 = st.columns([1, 1.5])

    with col1:
        with st.container(border=True):
            st.subheader("üóìÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á")
            country = st.selectbox("Destination", ["South Korea", "Japan", "Vietnam"])
            activity = st.selectbox("Activity", ["‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢"])
            gender = st.radio("Gender", ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"])
            img_file = st.file_uploader("üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ä‡∏∏‡∏î", type=['jpg', 'png'])
            run_btn = st.button("‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå")

    with col2:
        if run_btn:
            v_out, img_url = process_logic(api_key, country, activity, gender, use_free_mode, img_file, lang)
            
            # ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ AI Critique)
            st.markdown("### üîç AI Critique & Analysis")
            st.markdown(f'<div class="critique-box">{v_out}</div>', unsafe_allow_html=True)

            # ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏Ç‡πâ‡∏≠ 9)
            st.markdown("### üé≠ ‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (3D Visual)")
            if img_url: st.image(img_url, use_container_width=True)
            st.divider()

            # ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 & 4: ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (5 ‡∏Ç‡πâ‡∏≠‡∏´‡∏•‡∏±‡∏Å) + ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
            st.markdown("### üõçÔ∏è 5 ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°")
            
            # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ (‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)
            must_buy_items = [
                ("‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß (Down Jacket)", "‡πÄ‡∏ô‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏±‡∏ô‡∏•‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô"),
                ("‡∏ä‡∏∏‡∏î‡∏•‡∏≠‡∏á‡∏à‡∏≠‡∏ô (Heattech)", "‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏Å‡∏•‡πâ 0¬∞C"),
                ("‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ö‡∏π‡∏ó‡∏ö‡∏∏‡∏Ç‡∏ô", "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô"),
                ("‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡πâ‡∏≤‡∏û‡∏±‡∏ô‡∏Ñ‡∏≠", "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏Ñ‡∏≠"),
                ("‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô (Hot Pack)", "‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ô‡∏≤‡∏ô‡πÜ")
            ]

            for title, desc in must_buy_items:
                st.markdown(f"""
                <div class="must-buy-card">
                    <strong>üîπ {title}</strong><br>
                    <small>{desc}</small><br>
                    <a class="shop-link" href="https://shopee.co.th/search?keyword={quote_plus(title)}">üõí Shopee</a> | 
                    <a class="shop-link" href="https://www.lazada.co.th/catalog/?q={quote_plus(title)}">üõí Lazada</a>
                </div>
                """, unsafe_allow_html=True)
        else:
            st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ä‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå")

# --- ‡∏£‡∏∞‡∏ö‡∏ö Login ---
def login_page():
    st.markdown('<div style="text-align:center"><h1>Tripnify Login</h1></div>', unsafe_allow_html=True)
    if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Demo)"): 
        st.session_state['logged_in'] = True
        st.rerun()

if 'logged_in' not in st.session_state: st.session_state['logged_in'] = False
if st.session_state['logged_in']: main_dashboard()
else: login_page()
