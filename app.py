import streamlit as st
import base64
from openai import OpenAI
from urllib.parse import quote_plus
from datetime import datetime, timedelta
import streamlit.components.v1 as components

# --- üåê 0. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤ ---
LANG_DATA = {
    "Thai": {
        "settings": "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",
        "lang_label": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ (Language)",
        "theme_label": "‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á)",
        "api_label": "OpenAI API Key",
        "free_mode": "‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ",
        "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        "travel_info": "üóìÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "dest": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á",
        "city": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
        "start_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ",
        "end_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö",
        "activity_label": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
        "activities": ["‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏¥‡∏°‡∏∞/‡∏™‡∏Å‡∏µ", "‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢/‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á"],
        "gender": "‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏®",
        "male": "‡∏ä‡∏≤‡∏¢",
        "female": "‡∏´‡∏ç‡∏¥‡∏á",
        "upload_section": "üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
        "run_btn": "‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢",
        "temp_label": "üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢",
        "analysis_title": "üîç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢",
        "shop_title": "üõçÔ∏è ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
        "login_sub": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "login_btn": "üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        "reg_btn": "üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
        "guest_btn": "üë§ ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ"
    }
}

CITY_DATA = {
    "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": ["‡πÇ‡∏ï‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß", "‡πÇ‡∏≠‡∏ã‡∏≤‡∏Å‡πâ‡∏≤", "‡∏Æ‡∏≠‡∏Å‡πÑ‡∏Å‡πÇ‡∏î"],
    "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ": ["‡πÇ‡∏ã‡∏•", "‡∏õ‡∏π‡∏ã‡∏≤‡∏ô", "‡πÄ‡∏ä‡∏à‡∏π"],
    "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": ["‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢", "‡πÇ‡∏Æ‡∏à‡∏¥‡∏°‡∏¥‡∏ô‡∏´‡πå"],
    "‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô": ["‡πÑ‡∏ó‡πÄ‡∏õ", "‡πÄ‡∏Å‡∏≤‡∏™‡∏á"],
    "‡∏à‡∏µ‡∏ô": ["‡∏õ‡∏±‡∏Å‡∏Å‡∏¥‡πà‡∏á", "‡πÄ‡∏ã‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏Æ‡πâ"]
}

# --- üéÆ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 3D Model ---
def render_3d_model():
    st.markdown("### üé≠ 3D Outfit Character Preview")
    components.html("""
        <div id="viewer-3d" style="width: 100%; height: 400px; background: radial-gradient(circle, #334155 0%, #0f172a 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; cursor: grab; border: 2px solid #6366f1;">
            <div id="character" style="font-size: 150px; transition: transform 0.1s linear; user-select: none;">üß•</div>
            <div style="position: absolute; bottom: 20px; color: #94a3b8; font-family: sans-serif; font-size: 12px; pointer-events: none;">[ ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏î‡∏π‡∏ä‡∏∏‡∏î‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß 360¬∞ ]</div>
        </div>
        <script>
            const el = document.getElementById('viewer-3d');
            const char = document.getElementById('character');
            let isDragging = false; let rotation = 0; let startX;
            el.onmousedown = (e) => { isDragging = true; startX = e.pageX; el.style.cursor = 'grabbing'; };
            window.onmouseup = () => { isDragging = false; el.style.cursor = 'grab'; };
            window.onmousemove = (e) => {
                if (!isDragging) return;
                const delta = e.pageX - startX;
                rotation += delta * 0.5;
                char.style.transform = `rotateY(${rotation}deg)`;
                startX = e.pageX;
            };
        </script>
    """, height=420)

# --- ‚öôÔ∏è 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô) ---
def process_analysis(api_key, country, city, activity, use_free_mode, lang):
    if api_key and not use_free_mode:
        try:
            client = OpenAI(api_key=api_key)
            # ‡∏™‡∏±‡πà‡∏á AI ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            prompt = f"‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡πÑ‡∏õ {city}, {country} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: {activity}. ‡∏ö‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° ‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏†‡∏≤‡∏©‡∏≤: {lang}"
            
            # (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ client.chat.completions.create)
            # ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£
            analysis_text = f"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ {city} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"
            items = [
                {"name": "Heattech Ultra Warm", "reason": "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡∏≤‡∏ß‡∏à‡∏±‡∏î"},
                {"name": "Ultra Light Down", "reason": "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏ö‡∏≤ ‡∏û‡∏Å‡∏û‡∏≤‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏•‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°"},
                {"name": "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡∏ä‡∏™‡∏Å‡∏£‡∏µ‡∏ô", "reason": "‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏°‡∏∑‡∏≠‡∏≠‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å"}
            ]
            return {"text": analysis_text, "items": items}, True
        except Exception as e:
            return {"text": f"API Error: {e}", "items": []}, False
    else:
        v_free = "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡∏∏‡∏î‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß 3 ‡∏ä‡∏±‡πâ‡∏ô: Heattech, ‡πÑ‡∏´‡∏°‡∏û‡∏£‡∏°, ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏ö‡∏∏‡∏Ç‡∏ô"
        items_free = [{"name": "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß", "reason": "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô"}, {"name": "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ö‡∏∏‡∏Ç‡∏ô", "reason": "‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏á‡∏•‡πà‡∏≤‡∏á‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô"}]
        return {"text": v_free, "items": items_free}, False

# --- üé® 3. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ---
def main_dashboard():
    t = LANG_DATA["Thai"]
    with st.sidebar:
        st.subheader(t["settings"])
        api_key = st.text_input(t["api_label"], type="password")
        use_free_mode = st.toggle(t["free_mode"], value=not api_key)
        if st.button(t["logout"]):
            st.session_state['logged_in'] = False
            st.rerun()

    st.title("üåç Tripnify Dashboard")
    col1, col2 = st.columns([1, 1.4])

    with col1:
        with st.container(border=True):
            st.subheader(t["travel_info"])
            country = st.selectbox(t["dest"], list(CITY_DATA.keys()))
            city = st.selectbox(t["city"], CITY_DATA[country])
            activity = st.multiselect(t["activity_label"], t["activities"], default=t["activities"][0])
            run_btn = st.button(t["run_btn"], use_container_width=True, type="primary")

    with col2:
        if run_btn:
            data, is_premium = process_analysis(api_key, country, city, activity, use_free_mode, "Thai")
            
            # [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1] ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢
            st.subheader(t["analysis_title"])
            st.info(data["text"])
            
            st.divider()

            # [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2] 3D Model
            render_3d_model()

            st.divider()

            # [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3] ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ï‡∏≤‡∏° Brand)
            st.subheader(t["shop_title"])
            st.markdown("""
                <style>
                .btn-shopee { background-color: #EE4D2D !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .btn-uniqlo { background-color: #FF0000 !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .btn-lazada { background-color: #00008B !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .item-box { border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; background-color: rgba(255,255,255,0.05); }
                </style>
            """, unsafe_allow_html=True)

            for item in data["items"]:
                kw = quote_plus(item['name'])
                st.markdown(f"""
                    <div class="item-box">
                        <h4 style="margin:0;">üîπ {item['name']}</h4>
                        <p style="font-size: 0.9rem; color: #888;">{item['reason']}</p>
                        <a href="https://shopee.co.th/search?keyword={kw}" target="_blank" class="btn-shopee">üü† Shopee</a>
                        <a href="https://www.uniqlo.com/th/th/search/?q={kw}" target="_blank" class="btn-uniqlo">üî¥ Uniqlo</a>
                        <a href="https://www.lazada.co.th/catalog/?q={kw}" target="_blank" class="btn-lazada">üîµ Lazada</a>
                    </div>
                """, unsafe_allow_html=True)

# --- üîë 4. ‡∏´‡∏ô‡πâ‡∏≤ Login ---
def login_page():
    t = LANG_DATA["Thai"]
    st.markdown("<center><img src='https://cdn-icons-png.flaticon.com/512/201/201623.png' width='100'></center>", unsafe_allow_html=True)
    st.markdown("<h1 style='text-align: center;'>Tripnify</h1>", unsafe_allow_html=True)
    
    _, col, _ = st.columns([1, 2, 1])
    with col:
        st.text_input("Username")
        st.text_input("Password", type="password")
        if st.button(t["login_btn"], use_container_width=True, type="primary"):
            st.session_state['logged_in'] = True
            st.rerun()
        if st.button(t["guest_btn"], use_container_width=True):
            st.session_state['logged_in'] = True
            st.rerun()

# --- üöÄ 5. ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å ---
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False

if st.session_state['logged_in']:
    main_dashboard()
else:
    login_page()
