import streamlit as st
import base64
from datetime import datetime, timedelta

# --- üåê 0. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤ (Unified Language Control) ---
LANG_DATA = {
    "Thai": {
        "settings": "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",
        "lang_label": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ (Language)",
        "theme_label": "‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á)",
        "api_label": "OpenAI API Key",
        "free_mode": "‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ",
        "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        "travel_info": "üóìÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "dest": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á",
        "city": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
        "start_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ",
        "end_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö",
        "activity_label": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
        "activities": ["‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏¥‡∏°‡∏∞/‡∏™‡∏Å‡∏µ", "‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢/‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á"],
        "upload_section": "üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
        "run_btn": "‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢",
        "login_sub": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "login_btn": "üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        "reg_btn": "üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
        "guest_btn": "üë§ ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ"
    },
    "English": {
        "settings": "‚öôÔ∏è System Settings",
        "lang_label": "Language",
        "theme_label": "Display Mode (Dark/Light)",
        "api_label": "OpenAI API Key",
        "free_mode": "Free Mode",
        "logout": "Log Out",
        "travel_info": "üóìÔ∏è Travel Info",
        "dest": "Destination",
        "city": "City",
        "start_date": "Departure",
        "end_date": "Return",
        "activity_label": "Activities",
        "activities": ["Photography", "Business", "Ski/Snow", "Hiking/Adventure", "Shopping"],
        "upload_section": "üì∏ Image Management",
        "run_btn": "‚ú® Start Analysis",
        "login_sub": "Smart Outfit Analysis for Your Trip",
        "login_btn": "üîë Login",
        "reg_btn": "üìù Register",
        "guest_btn": "üë§ Guest"
    }
}

CITY_DATA = {
    "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": ["‡πÇ‡∏ï‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß", "‡πÇ‡∏≠‡∏ã‡∏≤‡∏Å‡πâ‡∏≤", "‡∏Æ‡∏≠‡∏Å‡πÑ‡∏Å‡πÇ‡∏î"],
    "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ": ["‡πÇ‡∏ã‡∏•", "‡∏õ‡∏π‡∏ã‡∏≤‡∏ô", "‡πÄ‡∏ä‡∏à‡∏π"],
    "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": ["‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢", "‡πÇ‡∏Æ‡∏à‡∏¥‡∏°‡∏¥‡∏ô‡∏´‡πå"],
    "‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô": ["‡πÑ‡∏ó‡πÄ‡∏õ", "‡πÄ‡∏Å‡∏≤‡∏™‡∏á"],
    "‡∏à‡∏µ‡∏ô": ["‡∏õ‡∏±‡∏Å‡∏Å‡∏¥‡πà‡∏á", "‡πÄ‡∏ã‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏Æ‡πâ"]
}

# --- üé® 1. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ---
def main_dashboard():
    # ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏†‡∏≤‡∏©‡∏≤
    current_lang = st.session_state.get('lang_choice', 'Thai')
    t = LANG_DATA[current_lang]

    # --- üåì Sidebar & Theme Control ---
    with st.sidebar:
        st.subheader(t["settings"])
        st.radio(t["lang_label"], ["Thai", "English"], key='lang_choice', horizontal=True)
        
        st.divider()
        api_key = st.text_input(t["api_label"], type="password")
        use_free_mode = st.toggle(t["free_mode"], value=not api_key)
        
        dark_mode = st.toggle(t["theme_label"], value=False)
        if dark_mode:
            # Soft Dark Mode (Slate Blue Theme)
            st.markdown("""
                <style>
                .stApp { background-color: #0f172a; color: #f8fafc; }
                [data-testid="stSidebar"] { background-color: #1e293b; }
                .stSelectbox label, .stDateInput label, .stRadio label, .stMultiSelect label, p, h1, h2, h3 { color: #e2e8f0 !important; }
                .stButton button { background-color: #334155 !important; border: 1px solid #475569 !important; color: white !important; }
                div[data-testid="stExpander"] { background-color: #1e293b; border: 1px solid #334155; }
                /* ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ Metric ‡πÅ‡∏•‡∏∞ Warning ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î */
                [data-testid="stMetricValue"] { color: #38bdf8 !important; }
                .stAlert { background-color: #1e293b; color: #f8fafc; border: 1px solid #334155; }
                </style>
            """, unsafe_allow_html=True)

        if st.button(t["logout"], use_container_width=True):
            st.session_state['logged_in'] = False
            st.rerun()

    # --- üóìÔ∏è Main Content ---
    st.title("üåç Tripnify Dashboard")
    
    col1, col2 = st.columns([1, 1.4])
    with col1:
        with st.container(border=True):
            st.subheader(t["travel_info"])
            country = st.selectbox(t["dest"], list(CITY_DATA.keys()))
            city = st.selectbox(t["city"], CITY_DATA[country])
            
            # 1. ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡πÑ‡∏õ-‡∏Å‡∏•‡∏±‡∏ö
            d_col1, d_col2 = st.columns(2)
            with d_col1:
                start = st.date_input(t["start_date"], datetime.now())
            with d_col2:
                end = st.date_input(t["end_date"], datetime.now() + timedelta(days=3))
            
            # 2. ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            activity = st.multiselect(t["activity_label"], t["activities"], default=t["activities"][0])
            
            st.divider()
            
            # 3. ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Tabs ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î/‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ)
            st.subheader(t["upload_section"])
            tabs = st.tabs(["üìÅ ‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û", "üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û"])
            with tabs[0]:
                img_file = st.file_uploader("", type=['jpg','png','jpeg'], key="dash_up")
            with tabs[1]:
                cam_file = st.camera_input("")
            
            active_img = img_file if img_file else cam_file
            
            if st.button(t["run_btn"], use_container_width=True, type="primary"):
                if active_img:
                    st.success("‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...")
                else:
                    st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°")

    with col2:
        st.info("üí° ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI ‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ 3D ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")

# --- üîë 2. ‡∏´‡∏ô‡πâ‡∏≤ Login ---
def login_page():
    current_lang = st.session_state.get('lang_choice', 'Thai')
    t = LANG_DATA[current_lang]

    st.markdown("""<style>
        .header-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; padding: 30px 0; }
        .social-btn-custom { display: flex; align-items: center; justify-content: center; border: 1px solid #dadce0; border-radius: 8px; padding: 10px; margin-bottom: -45px; background: white; position: relative; z-index: 1; pointer-events: none; width: 100%; }
        .social-icon { width: 20px; margin-right: 12px; }
        .social-text { font-weight: 500; font-size: 14px; }
    </style>""", unsafe_allow_html=True)

    st.markdown(f"""
        <div class="header-container">
            <img src="https://cdn-icons-png.flaticon.com/512/201/201623.png" width="140">
            <h1 style='margin-top: 15px; font-size: 3.5rem; font-weight: bold;'>Tripnify</h1>
            <p style='color: gray; font-size: 1.2rem; margin-top: -15px;'>{t['login_sub']}</p>
        </div>
    """, unsafe_allow_html=True)

    _, c2, _ = st.columns([1, 1.6, 1])
    with c2:
        # Facebook
        st.markdown(f"""<div class="social-btn-custom">
            <img class="social-icon" src="https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg">
            <span class="social-text" style="color: #1877F2;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Facebook</span>
        </div>""", unsafe_allow_html=True)
        if st.button("", key="fb_btn", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()

        # Google
        st.markdown(f"""<div class="social-btn-custom">
            <img class="social-icon" src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png">
            <span class="social-text" style="color: #5F6368;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</span>
        </div>""", unsafe_allow_html=True)
        if st.button("", key="google_btn", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()

        st.markdown("<hr style='margin-top: 25px; opacity: 0.3;'>", unsafe_allow_html=True)
        
        user = st.text_input("Username", placeholder="Username")
        pwd = st.text_input("Password", type="password", placeholder="Password")
        
        if st.button(t["login_btn"], use_container_width=True, type="primary"):
            st.session_state['logged_in'] = True; st.rerun()

        col_sub1, col_sub2 = st.columns(2)
        with col_sub1: st.button(t["reg_btn"], use_container_width=True)
        with col_sub2:
            if st.button(t["guest_btn"], use_container_width=True):
                st.session_state['logged_in'] = True; st.rerun()

# --- üöÄ 3. Main Controller ---
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False
if 'lang_choice' not in st.session_state:
    st.session_state['lang_choice'] = 'Thai'

if st.session_state['logged_in']:
    main_dashboard()
else:
    login_page()
