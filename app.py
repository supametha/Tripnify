import streamlit as st
import base64
from openai import OpenAI
from urllib.parse import quote_plus
from datetime import datetime, timedelta
import streamlit.components.v1 as components

# --- üåê 0. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤ ---
LANG_DATA = {
    "Thai": {
        "settings": "‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö",
        "lang_label": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏≤ (Language)",
        "theme_label": "‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á)",
        "api_label": "OpenAI API Key",
        "free_mode": "‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ",
        "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö",
        "travel_info": "üóìÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "dest": "‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á",
        "city": "‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
        "start_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ",
        "end_date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö",
        "activity_label": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
        "activities": ["‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ", "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏¥‡∏°‡∏∞/‡∏™‡∏Å‡∏µ", "‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢/‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á"],
        "gender": "‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏®",
        "male": "‡∏ä‡∏≤‡∏¢",
        "female": "‡∏´‡∏ç‡∏¥‡∏á",
        "upload_section": "üì∏ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û",
        "run_btn": "‚ú® ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢",
        "temp_label": "üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢",
        "analysis_title": "üîç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢",
        "shop_title": "üõçÔ∏è ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
        "login_sub": "‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        "login_btn": "üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
        "reg_btn": "üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
        "guest_btn": "üë§ ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ",
        "essentials": ["‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß", "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ö‡∏∏‡∏Ç‡∏ô", "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß", "‡πÅ‡∏ú‡πà‡∏ô‡πÅ‡∏õ‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô"]
    },
    "English": {
        "settings": "‚öôÔ∏è System Settings",
        "lang_label": "Language",
        "theme_label": "Display Mode (Dark/Light)",
        "api_label": "OpenAI API Key",
        "free_mode": "Free Mode",
        "logout": "Log Out",
        "travel_info": "üóìÔ∏è Travel Info",
        "dest": "Destination",
        "city": "City",
        "start_date": "Departure",
        "end_date": "Return",
        "activity_label": "Activities",
        "activities": ["Photography", "Business", "Ski/Snow", "Hiking/Adventure", "Shopping"],
        "gender": "Gender",
        "male": "Male",
        "female": "Female",
        "upload_section": "üì∏ Image Management",
        "run_btn": "‚ú® Start Analysis",
        "temp_label": "üå°Ô∏è Avg Temp",
        "analysis_title": "üîç Outfit Analysis",
        "shop_title": "üõçÔ∏è Recommended Shopping",
        "login_sub": "Smart Outfit Analysis for Your Trip",
        "login_btn": "üîë Login",
        "reg_btn": "üìù Register",
        "guest_btn": "üë§ Guest",
        "essentials": ["Winter Coat", "Fleece Pants", "Winter Gloves", "Heat Packs"]
    }
}

CITY_DATA = {
    "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô": ["‡πÇ‡∏ï‡πÄ‡∏Å‡∏µ‡∏¢‡∏ß", "‡πÇ‡∏≠‡∏ã‡∏≤‡∏Å‡πâ‡∏≤", "‡∏Æ‡∏≠‡∏Å‡πÑ‡∏Å‡πÇ‡∏î"],
    "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ": ["‡πÇ‡∏ã‡∏•", "‡∏õ‡∏π‡∏ã‡∏≤‡∏ô", "‡πÄ‡∏ä‡∏à‡∏π"],
    "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°": ["‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢", "‡πÇ‡∏Æ‡∏à‡∏¥‡∏°‡∏¥‡∏ô‡∏´‡πå"],
    "‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô": ["‡πÑ‡∏ó‡πÄ‡∏õ", "‡πÄ‡∏Å‡∏≤‡∏™‡∏á"],
    "‡∏à‡∏µ‡∏ô": ["‡∏õ‡∏±‡∏Å‡∏Å‡∏¥‡πà‡∏á", "‡πÄ‡∏ã‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏Æ‡πâ"]
}

# --- üéÆ 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• 3D Model (Premium) ---
def render_3d_model():
    st.markdown("### üé≠ 3D Outfit Character Preview")
    components.html("""
        <div id="viewer-3d" style="width: 100%; height: 400px; background: radial-gradient(circle, #334155 0%, #0f172a 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; position: relative; cursor: grab; border: 2px solid #6366f1;">
            <div id="character" style="font-size: 150px; transition: transform 0.1s linear; user-select: none;">üß•</div>
            <div style="position: absolute; bottom: 20px; color: #94a3b8; font-family: sans-serif; font-size: 12px; pointer-events: none;">
                [ ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏î‡∏π‡∏ä‡∏∏‡∏î‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß 360¬∞ ]
            </div>
        </div>
        <script>
            const el = document.getElementById('viewer-3d');
            const char = document.getElementById('character');
            let isDragging = false; let rotation = 0; let startX;
            el.onmousedown = (e) => { isDragging = true; startX = e.pageX; el.style.cursor = 'grabbing'; };
            window.onmouseup = () => { isDragging = false; el.style.cursor = 'grab'; };
            window.onmousemove = (e) => {
                if (!isDragging) return;
                const delta = e.pageX - startX;
                rotation += delta * 0.5;
                char.style.transform = `rotateY(${rotation}deg)`;
                startX = e.pageX;
            };
        </script>
    """, height=420)

# --- ‚öôÔ∏è 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô ---
def process_analysis(api_key, country, city, activity, use_free_mode, uploaded_file, lang, start_date, end_date):
    days = (end_date - start_date).days + 1
    if api_key and not use_free_mode:
        try:
            client = OpenAI(api_key=api_key)
            # ‡∏õ‡∏£‡∏±‡∏ö Prompt ‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡πà‡∏≤‡∏¢
            prompt = f"""Analyze winter outfit for {city}, {country}. Activity: {activity}. 
            Provide: 1. General analysis text. 2. A list of 3 specific essential items with reasons why they are suitable.
            Response Language: {lang}"""
            
            # (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)
            analysis_text = f"‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ {city} ‡πÉ‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ 2¬∞C ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢"
            items = [
                {"name": "Heattech Ultra Warm", "reason": "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏•‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"},
                {"name": "Down Jacket ‡∏Å‡∏±‡∏ô‡∏•‡∏°", "reason": "‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏•‡∏°‡∏´‡∏ô‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏´‡∏¥‡∏°‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡∏∂‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏ô"},
                {"name": "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ç‡∏ô‡πÅ‡∏Å‡∏∞", "reason": "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏ä‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å"}
            ]
            return {"text": analysis_text, "items": items}, True
        except Exception as e:
            return {"text": f"Error: {e}", "items": []}, False
    else:
        # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Free Mode
        v_free = "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ä‡∏∏‡∏î‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß 3 ‡∏ä‡∏±‡πâ‡∏ô: Heattech, ‡πÑ‡∏´‡∏°‡∏û‡∏£‡∏°, ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏ö‡∏∏‡∏Ç‡∏ô"
        items_free = [
            {"name": "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏Ñ‡πâ‡∏ó‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß", "reason": "‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏ß‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ï‡∏¥‡∏î‡∏•‡∏ö"},
            {"name": "‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á‡∏ö‡∏∏‡∏Ç‡∏ô", "reason": "‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ç‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ï‡πà‡∏≥‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô"}
        ]
        return {"text": v_free, "items": items_free}, False

# --- üé® 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Dashboard (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô col2) ---
    with col2:
        if run_btn:
            data, is_premium = process_analysis(api_key, country, city, activity, use_free_mode, active_img, current_lang, start, end)
            
            # Weather Widget
            w_col1, w_col2 = st.columns([1, 2])
            w_col1.metric(t["temp_label"], "2¬∞C")
            w_col2.warning(f"‚ùÑÔ∏è ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏´‡∏ô‡∏≤‡∏ß‡∏à‡∏±‡∏î‡πÉ‡∏ô {city}")
            
            st.divider()

            # --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1] ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢ ---
            st.subheader(t["analysis_title"])
            st.markdown(f'<div class="analysis-box">{data["text"]}</div>', unsafe_allow_html=True)
            
            st.divider()

            # --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 2] 3D Model ---
            if is_premium:
                render_3d_model()
            else:
                st.image("https://images.unsplash.com/photo-1517495306684-21523df7d62c?q=80&w=1000", caption="Reference Outfit (Free Mode)")

            st.divider()

            # --- [‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 3] ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° Brand ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á Keyword) ---
            st.subheader(t["shop_title"])
            
            # CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
            st.markdown("""
                <style>
                .btn-shopee { background-color: #EE4D2D !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .btn-uniqlo { background-color: #FF0000 !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .btn-lazada { background-color: #00008B !important; color: white !important; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; display: inline-block; margin: 5px 2px; }
                .item-card { border: 1px solid #ddd; padding: 15px; border-radius: 12px; margin-bottom: 15px; background-color: rgba(255,255,255,0.05); }
                </style>
            """, unsafe_allow_html=True)

            for item in data["items"]:
                kw = quote_plus(item['name'])
                st.markdown(f"""
                    <div class="item-card">
                        <h4 style="margin-bottom:5px;">üîπ {item['name']}</h4>
                        <p style="font-size: 0.9rem; color: #888; margin-bottom:15px;">{item['reason']}</p>
                        <a href="https://shopee.co.th/search?keyword={kw}" target="_blank" class="btn-shopee">üü† Shopee</a>
                        <a href="https://www.uniqlo.com/th/th/search/?q={kw}" target="_blank" class="btn-uniqlo">üî¥ Uniqlo</a>
                        <a href="https://www.lazada.co.th/catalog/?q={kw}" target="_blank" class="btn-lazada">üîµ Lazada</a>
                    </div>
                """, unsafe_allow_html=True)
        else:
            st.info("üëà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ 3D")

# --- üîë 4. ‡∏´‡∏ô‡πâ‡∏≤ Login ---
def login_page():
    current_lang = st.session_state.get('lang_choice', 'Thai')
    t = LANG_DATA[current_lang]

    st.markdown("""<style>
        .header-container { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; width: 100%; padding: 30px 0; }
        .social-btn-custom { display: flex; align-items: center; justify-content: center; border: 1px solid #dadce0; border-radius: 8px; padding: 10px; margin-bottom: -45px; background: white; position: relative; z-index: 1; pointer-events: none; width: 100%; }
        .social-icon { width: 20px; margin-right: 12px; }
        .social-text { font-weight: 500; font-size: 14px; color: #3c4043; }
    </style>""", unsafe_allow_html=True)

    st.markdown(f"""
        <div class="header-container">
            <img src="https://cdn-icons-png.flaticon.com/512/201/201623.png" width="130">
            <h1 style='margin-top: 15px; font-size: 3.5rem; font-weight: bold;'>Tripnify</h1>
            <p style='color: gray; font-size: 1.2rem; margin-top: -15px;'>{t['login_sub']}</p>
        </div>
    """, unsafe_allow_html=True)

    _, c2, _ = st.columns([1, 1.6, 1])
    with c2:
        st.markdown(f"""<div class="social-btn-custom">
            <img class="social-icon" src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png">
            <span class="social-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</span>
        </div>""", unsafe_allow_html=True)
        if st.button("", key="g_login", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()

        st.markdown(f"""<div class="social-btn-custom">
            <img class="social-icon" src="https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg">
            <span class="social-text" style="color: #1877F2;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Facebook</span>
        </div>""", unsafe_allow_html=True)
        if st.button("", key="f_login", use_container_width=True):
            st.session_state['logged_in'] = True; st.rerun()

        st.markdown("<hr style='margin: 25px 0; opacity: 0.3;'>", unsafe_allow_html=True)
        user = st.text_input("Username", placeholder="Username")
        pwd = st.text_input("Password", type="password", placeholder="Password")
        
        if st.button(t["login_btn"], use_container_width=True, type="primary"):
            st.session_state['logged_in'] = True; st.rerun()

        col_sub1, col_sub2 = st.columns(2)
        with col_sub1: st.button(t["reg_btn"], use_container_width=True)
        with col_sub2:
            if st.button(t["guest_btn"], use_container_width=True):
                st.session_state['logged_in'] = True; st.rerun()

# --- üöÄ 5. Main Controller ---
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False
if 'lang_choice' not in st.session_state:
    st.session_state['lang_choice'] = 'Thai'

if st.session_state['logged_in']:
    main_dashboard()
else:
    login_page()
